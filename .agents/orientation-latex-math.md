# Orientation: LaTeX and Mathematics

> **Quick start:**
> - Read this before editing any `.tex` file or equation.
> - Covers: document structure, subfiles, build system, boolean flags, custom macro families.
> - See also: [orientation-code.md](orientation-code.md) for how code implements the math; [codeinfo-spec.md](codeinfo-spec.md) for the `%% CodeInfo:` annotation format.

This document describes how the LaTeX source in this repo is organized, how it compiles into `SolvingMicroDSOPs.pdf`, and the non-obvious conventions an AI must understand before making changes.

---

## What this document is

**SolvingMicroDSOPs** ("Solving Microeconomic Dynamic Stochastic Optimization Problems") is a set of lecture notes on numerical methods for solving consumption/saving problems under uncertainty. It lives in a single LaTeX project that compiles to PDF.

The mathematical content describes:

- A finite-horizon consumption/savings problem with income uncertainty (Sections 1--4).
- Normalization and notation for the Bellman equation and its stages (Sections 3--4).
- Standard solution theory: value function iteration, the Euler equation, the envelope condition (Section 5).
- Practical solution methods: end-of-period value function, EGM (Endogenous Grid Method), interpolation, multi-period backward induction (Section 6).
- Extension to multiple control variables (portfolio choice between risky and risk-free assets) (Section 7).
- Structural estimation via Simulated Method of Moments matching SCF data (Section 8).

---

## Document structure

### Main entry point

`SolvingMicroDSOPs.tex` at the repo root. This file:

1. Sets up the document class (`econark`, a custom KOMA-Script-based class).
2. Loads packages and custom macros (`local-macros`, `econark`, etc.).
3. Reads boolean flags from `SolvingMicroDSOPs-options.tex`.
4. Includes each section via `\subfile{_sectn-<name>}`.
5. Includes appendices via `\subfile{_apndx-<name>}`.
6. Runs the bibliography.

### Section files (`_sectn-*.tex`)

Each section is a standalone `subfiles` document:

```latex
\input{@resources/tex-add-search-paths}
\documentclass[SolvingMicroDSOPs]{subfiles}
\input{subfile-start}
\begin{document}
\hypertarget{...}{}
\section{...}\label{sec:...}
% content
\end{document}
```

This means **every section can be compiled independently** (useful for testing). The `subfiles` package delegates preamble handling to the parent `SolvingMicroDSOPs.tex`.

Key section files and what they cover:

| File | Topic |
|------|-------|
| `_sectn-the-problem.tex` | The optimization problem statement |
| `_sectn-normalization.tex` | Normalizing by permanent income |
| `_sectn-notation.tex` | Stage/interval/connector notation |
| `_sectn-the-usual-theory.tex` | Standard Bellman, Euler, envelope theory |
| `_sectn-solving-the-next.tex` | EGM, interpolation, backward induction, the "Pile" |
| `_sectn-the-infinite-horizon.tex` | Convergence to the infinite-horizon solution |
| `_sectn-multiple-control-variables.tex` | Portfolio choice (risky + risk-free asset) |
| `_sectn-structural-estimation.tex` | SMM estimation using SCF data |

### Equation fragments (`Equations/`)

Equations are **kept in separate small `.tex` files** in `Equations/` and pulled into sections via `\input{./Equations/FileName}`.

A common pattern uses `verbatimwrite` to define the equation in-place and simultaneously write it to a file for later reuse:

```latex
\begin{verbatimwrite}{./Equations/cEuler}
  \begin{equation}\label{eq:cEuler}
    ...
  \end{equation}
\end{verbatimwrite}
\input{./Equations/cEuler}\unskip
```

This means the **same equation can be `\input`-ed in multiple places** without duplication.

### Figures (`Figures/`)

Figures are included via `\includegraphics`. Most are `.eps` files (legacy, from MATLAB/Mathematica). A few newer ones are `.pdf` or `.svg` generated by Python. Each `.eps` typically has a companion `.xbb` bounding-box file for the LaTeX compiler.

### Tables (`Tables/`)

Tables are `.tex` fragments (e.g. `Tables/EstResults.tex`) included via `\input`.

---

## Build system

```bash
latexmk                 # uses .latexmkrc at repo root
```

The `.latexmkrc` sets `$pdf_mode = 4` (LuaLaTeX), `$bibtex_use = 2`, and targets `SolvingMicroDSOPs`.

### Search paths

The very first line of every `.tex` file is:

```latex
\input{@resources/tex-add-search-paths}
```

This configures `TEXINPUTS` so LaTeX can find custom `.sty` and `.cls` files in `@resources/` and `@local/`. Without this, compilation will fail.

---

## Boolean flags and conditional compilation

`SolvingMicroDSOPs-options.tex` defines many booleans that control what appears in the PDF. The most important:

| Flag | Default | Effect |
|------|---------|--------|
| `shortVersion` | `false` | If true, skips sections after notation straight to multiple controls |
| `draftmode` | `true` | Shows `\label` names in the margin (via `showlabels`) |
| `hidetime` | `true` | Suppresses time subscripts in notation |
| `realcode` | `false` | Shows real (Python) code blocks |
| `pseudocode` | `false` | Shows pseudocode blocks |
| `demacro` | `false` | Replaces custom macros with their expanded forms |

These are consumed via `\ifthenelse{\boolean{flagName}}{true}{false}`.

---

## Custom macros you will encounter

All project-specific macros are defined in `@local/local-macros.sty`. Here are the most important families:

### Variable-level notation

The document uses a systematic `\<var><form>` naming pattern:

- **Normalized** (lowercase-ish): `\mNrm`, `\cNrm`, `\aNrm`, `\bNrm`, `\kNrm` — market resources, consumption, end-of-period assets, beginning-of-period assets, capital (all divided by permanent income).
- **Level** (uppercase-ish): `\mLvl`, `\cLvl`, `\aLvl`, `\bLvl`, `\kLvl` — the un-normalized dollar amounts.
- **Functions**: `\vFunc` (value), `\uFunc` (utility), `\cFunc` (consumption policy).

### Parameters

- `\DiscFac` — discount factor (beta)
- `\CRRA` — coefficient of relative risk aversion (rho)
- `\Rfree` — gross risk-free return
- `\Risky` — gross risky return
- `\Rport` — gross portfolio return
- `\PermGroFac` — permanent income growth factor

### Time and stage notation

The document introduces a structured period decomposition:

- `\prdt`, `\prdT` — period index, terminal period
- `\stg`, `\StgName{}` — stage within a period
- `\interval` — interval (sub-stage)
- `\prchs` — "perch" (a named point in the period flow)

Periods are decomposed into **stages**, stages into **intervals**, and the boundaries of intervals are **perches**. This is the "Pile" structure used to describe backward induction.

### Expectation operators

- `\Ex` — generic expectation
- `\ExEndPrd` — end-of-period expectation (over shocks)

### Connector and builder notation

- `\Cnct`, `\Cnctr`, `\Cncts` — connectors between stages
- `\BkBldrPrd` — backward builder operator
- `\Pile`, `\pileName` — the "Pile" data structure that accumulates solved periods
- `\leftassign` — creation/assignment operator

### Unified-framework annotations

Many equations carry a `\UnifiedNote{...}` comment that maps the local notation to a "unified" notation shared with the `bellman-ddsl` framework. **Preserve these annotations when editing equations.**

---

## How the math maps to the PDF

1. The reader sees numbered sections and equations in the PDF.
2. Each section corresponds to one `_sectn-*.tex` file.
3. Each labeled equation (e.g. `\label{eq:cEuler}`) can be cross-referenced anywhere via `\eqref{eq:cEuler}`.
4. Figures are numbered sequentially; each has a `\label{fig:...}`.
5. Boolean flags may hide or show entire sections or blocks.

When editing, always check which booleans gate the block you are in, and ensure `\label`/`\hypertarget` anchors remain consistent.

---

## Non-obvious things that will trip you up

1. **`@resources/` and `@local/` are directories, not LaTeX commands.** The `@` is part of the directory name. LaTeX finds them because `tex-add-search-paths` adds them to `TEXINPUTS`. They are excluded from the Cursor index (`.cursorignore`) but are essential for compilation.

2. **`docs/` is a frozen reference copy.** Never edit it. It exists so the author can diff the original (pre-rename) source against the current root files. All edits go to root-level files only.

3. **`verbatimwrite` creates files at compile time.** When you see `\begin{verbatimwrite}{./Equations/Foo}`, LaTeX writes that content to `Equations/Foo` during compilation. The file on disk may be the output of the last build, not hand-written source. Check whether an equation file is authoritative (hand-written, referenced but never `verbatimwrite`-d) or generated.

4. **The `subfiles` package means the preamble is shared.** If you add a package or macro, add it to `SolvingMicroDSOPs.tex` (or `local-macros.sty`), not to an individual section file.

5. **The `econark` document class** is not standard LaTeX. It is a custom class provided via `@resources/`. It extends KOMA-Script (`scrartcl`/`scrbook`) with econ-ark-specific defaults.

6. **Bibliography**: uses `econark.bst` style and `\econarkmultibib` for multiple `.bib` files. The system `.bib` is patched in at the bottom of the main file.

7. **Hyperlinks**: `\hypertarget{name}{}` is placed before most `\section` commands to provide stable link anchors. The companion `SolvingMicroDSOPs-hypersetup.tex` sets `colorlinks=true` and `citecolor=magenta`.
